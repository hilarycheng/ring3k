#
# Makefile for regression tests
# Copyright 2007-2008 Mike McCormack
#

srcdir = @srcdir@
VPATH  = @srcdir@

DEPFLAG = -Wp,-MD,.$@.d
CC=@MINGW32CC@
STRIP=@MINGW32STRIP@
CFLAGS=-Wall -O2 $(DEPFLAG) -I$(srcdir)/../include/common
AS=@MINGW32AS@
AR=@MINGW32AR@
RANLIB=@MINGW32RANLIB@
WINDRES=@MINGW32WINDRES@

TESTS = \
	atom.c \
	completion.c \
	device.c \
	event.c \
	eventpair.c \
	file.c \
	font.c \
	gdi.c \
	heap.c \
	job.c \
	key.c \
	mailslot.c \
	mutant.c \
	object.c \
	pipe.c \
	port.c \
	process.c \
	reg.c \
	section.c \
	seh.c \
	sema.c \
	syscall.c \
	thread.c \
	timer.c \
	token.c \
	user.c \
	virtual.c \
	wine-atom.c \
	wine-port.c

SOURCE = \
	$(TESTS) \
	hostnt.c \
	native.c \
	ps.c \
	runnt.c

ISO = nttests.iso

.PHONY: all clean

NTWIN32LIB=win2k/ntwin32.dll

all: $(SOURCE:.c=.exe) $(ISO) winxp/ntwin32.dll win2k/ntwin32.dll

include $(wildcard .*.d)

runtests.bat: Makefile
	echo @rem Generated by Makefile > $@
	for f in $(TESTS:%.c=%.exe); do echo @hostnt.exe $$f >> $@ ; done

# ntwin32.dll differs between windows versions
win2k/ntwin32.dll: win2k/ntwin32.o
	$(CC) -o $@ -shared -nostartfiles -nodefaultlibs $<

win2k/ntwin32.o: win2k/ntwin32.s
	$(AS) -o $@ $<

win2k/ntwin32.s: win2k/ntwin32.in gen_syscalls.pl
	mkdir -p win2k
	perl $(srcdir)/gen_syscalls.pl $< > $@

winxp/ntwin32.dll: winxp/ntwin32.o
	$(CC) -o $@ -shared -nostartfiles -nodefaultlibs $<

winxp/ntwin32.o: winxp/ntwin32.s
	$(AS) -o $@ $<

winxp/ntwin32.s: winxp/ntwin32.in gen_syscalls.pl
	mkdir -p winxp
	perl $(srcdir)/gen_syscalls.pl $< > $@

dillo.exe: dillo.o
	$(CC) -o $@ $< -lntdll

runnt.exe: runnt.o
	$(CC) -o $@ $< -lntdll -lkernel32

hostnt.exe: hostnt.o
	$(CC) -o $@ $< -lntdll -lkernel32

NATIVEEXEFLAGS = -lntdll -nostartfiles -nodefaultlibs -Wl,--subsystem=native -e _NtProcessStartup

gdi.exe: gdi.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

user.exe: user.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

key.exe: key.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

font.exe: font.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

atom.exe: atom.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

wine-atom.exe: wine-atom.o log.o $(NTWIN32LIB)
	$(CC) -o $@ $^ $(NATIVEEXEFLAGS)

%.exe: %.c log.o
	$(CC) $(CFLAGS) -o $@ log.o $< $(NATIVEEXEFLAGS)

# build an with the tests so that they can be easily run in QEMU
$(ISO): $(SOURCE:.c=.exe) $(NTWIN32LIB)
	cp -f $(NTWIN32LIB) ntwin32.dll
	genisoimage -r -J -input-charset utf-8 -o $(ISO) $(SOURCE:.c=.exe) ntwin32.dll

clean:
	$(RM) *.exe *.o *.s *.a *.bat *.dll .*.d
	$(RM) win2k/*.a win2k/*.s win2k/*.lib win2k/*.dll win2k/*.o
	$(RM) winxp/*.a winxp/*.s winxp/*.lib winxp/*.dll winxp/*.o
	$(RM) $(ISO)
